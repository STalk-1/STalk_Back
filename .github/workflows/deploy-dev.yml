name: Deploy (main -> OCI VM)

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Build (Gradle)
        run: ./gradlew clean build -x test

      - name: Docker login (Docker Hub)
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_IMAGE }}:main .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_IMAGE }}:main

      - name: Deploy via SSH (pull & restart)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            # 1. 프로젝트 폴더로 이동
            cd /home/ubuntu/stalkproj

            # Docker Hub login (VM에서도 pull 위해 필요)
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # 3. 환경 변수 설정
            cat > .env <<EOF
            DOCKER_IMAGE=${{ secrets.DOCKERHUB_IMAGE }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_REDIRECT_URI_DEV=${{ secrets.KAKAO_REDIRECT_URI_DEV }}
            EOF
            chmod 600 .env
            
            #4. 최신 이미지 가져오기 (pull) 
            docker compose pull
            
            # 4. 컨테이너 재시작 (변경사항 반영)
            docker compose up -d
            
            # 5. 사용하지 않는 오래된 이미지 정리 (용량 확보)
            docker image prune -f